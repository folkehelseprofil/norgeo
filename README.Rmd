---
output: github_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# norgeo

<!-- badges: start -->
<!-- badges: end -->

The aim of `norgeo` package is to be able to track changes to the geo codes in Norway. This is based on information and tables available on SSB [website](https://www.ssb.no/befolkning/artikler-og-publikasjoner/regionale-endringer-2020). Therefore, the use of this package might be limited to the data available from SSB.

## Installation

`norgeo` package can be installed directly from **GitHub** page of [Folkehelseprofil](https://github.com/folkehelseprofil). You can run the code below for installation. It will use `remotes` package to access to the **GitHub**. If you haven't installed it before, the package will be installed automatically prior to installing `norgeo`.

``` r
if(!require(remotes)) install.packages("remotes")
remotes::install.packages("folkehelseprofil/norgeo")
```

## Track code changes

You have to download the files from SSB and save it as a `csv` file. For the code changes, they have to be copied pasted in an Excel. These code changes can be found under *Endringer* tab in the website. It's advisable to name the file with a specific word to differentiate the file from the `csv` files. I would recommed to add the word `change`. For example `fylke_change_jan2018.xlsx` and the downloaded `csv` file will be `fylke_jan2028.csv`. It's also advisable to add the year to all files to easily differentiate them when running the code.

### Add changes

The `add_change()` function is the most important function to start with. This function will create an object that is easily used by other available functions in `norgeo`. This is where raw data in `csv` and `xlsx` formats will be merged. Additional information will also be added. The codes below show how the function is used:

```{r add-change, eval=FALSE}
## specify the folder where kommune files are
folder <- "F:/org/kommune"

kom2018 <- add_change("jan2018",
                      "change",
                      year = 2018,
                      type = "kommune",
                      folder.path = folder)

kom2019 <- add_change("jan2019",
                      "change",
                      year = 2019,
                      type = "kommune",
                      folder.path = folder)

kom2020 <- add_change("jan2020",
                      "change",
                      year = 2020,
                      type = "kommune",
                      folder.path = folder)

```

### Merge changes

To merge all these files into a big dataset, use `merge_geo()` function. Important to note that input for `merge_geo()` must be a **list** and they are arranged from oldest to most recent codes. Available output includes:

  - `all`    : All merged codes. This is the default
  - `change` : Only codes that have changed
  - `split`  : Codes that have been divided to at least two codes in the current list
  - `merge`  : At least two codes are merged into one in the current list

```{r merge-geo, eval=FALSE}

komfiles <- list(kom2018, kom2019, kom2020)
DF <- merge_geo(files = komfiles)
merge_geo(files = komfiles, output = "change")

```

### Save codes

The output created from `merge_geo()` i.e `DF`, can be saved in a database management system (DBMS) which include Access and SQLite, or as ordinary files such as Excel or text file. Database file be be available prior to saving it as a database table.

```{r db, eval=FALSE}
dbpath = "C:/Users/ybka/dbms"
dbname = "geo_ssb.accdb"

save_geo(tblname = "tblTest",
         obj = DT,
         des.path = dbpath,
         file.type = "Access",
         db.name = dbname)
```

## Add granularity

The function `cast_all()` will add lower granularity to all files when applicable. It means for *kommune* files, a new `fylke` column will be added, while column `fylke` and `kommune` will be added to a *bydle* and *grunnkrets* files.

```{r granularity, eval=FALSE}

file2020 <- c("F:/Geo/fylke/fylke_jan2020.csv",
              "F:/Geo/kommune/kommune_jan2020.csv",
              "F:/Geo/bydel/bydel_jan2020.csv",
              "F:/Geo/grunnkrets/grunnkrets_jan2020.csv")

fileTyp <- c("fylke", "kommune", "bydel", "grunnkrets")

DF <- cast_all(file = file2020,
               type = fileTyp,
               year = 2020)
```
